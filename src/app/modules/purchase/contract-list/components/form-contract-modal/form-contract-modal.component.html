<nz-modal
    nzCentered
    [(nzVisible)]="isVisible"
    [nzWidth]="1000"
    [nzFooter]="null"
    [nzKeyboard]="false"
    [nzMaskClosable]="false"
    (nzOnCancel)="isVisible = false"
    nzTitle="Tạo đơn đề nghị ký hợp đồng">
    <div class="card card-custom detail">
        <div class="card-body py-0">
            <!--begin: Step -->
            <div class="steps">
                <div class="step" [title]="'Thông tin chung' | translate">
                    <div class="step_number" [class.bg-primary-1]="step === 1" [class.text-white]="step === 1"
                        (click)="nextStep(1)">1</div>
                    <div class="step_title truncate" [class.text-primary-1]="step === 1"
                        [translate]="'Thông tin chung'"></div>
                    <div class="step_dot"></div>
                </div>
                <div class="step" [title]="'Thông tin hợp đồng' | translate">
                    <div class="step_number" [class.bg-primary-1]="step === 2" [class.text-white]="step === 2"
                        (click)="nextStep(2)">2</div>
                    <div class="step_title truncate" [class.text-primary-1]="step === 2"
                        [translate]="'Thông tin hợp đồng'"></div>
                    <div class="step_dot"></div>
                </div>
                <div class="step" [title]="'Thông tin hàng hoá' | translate">
                    <div class="step_number" [class.bg-primary-1]="step === 3" [class.text-white]="step === 3"
                        (click)="nextStep(3)">3</div>
                    <div class="step_title truncate" [class.text-primary-1]="step === 3"
                        [translate]="'Thông tin hàng hoá'"></div>
                    <div class="step_dot"></div>
                </div>
                <div class="step" [title]="'Hoàn thành' | translate">
                    <div class="step_number" [class.bg-primary-1]="step === 4" [class.text-white]="step === 4"
                        (click)="nextStep(4)">4</div>
                    <div class="step_title truncate" [class.text-primary-1]="step === 4"
                        [translate]="'Hoàn thành'"></div>
                    <div class="step_dot"></div>
                </div>
            </div>
            <!--end: Step -->
        </div>

        <!-- [1] -->
        <div [ngClass]="{'d-block': step == 1, 'd-none': step != 1}" class="card-body scroll-gray-8 py-0 px-10"
            style="max-height: calc(100vh - 275px);">
            <form [formGroup]="formGroup1">
                <div class="row mb-5">
                    <div class="col-12 col-md-5 ctrl_label">
                        Yêu cầu mua sắm
                    </div>
                    <div class="col-12 col-md-7 select_42">
                        <nz-select
                            nzMode="multiple"
                            nzPlaceHolder="Yêu cầu mua sắm"
                            nzAllowClear
                            nzShowSearch
                            nzServerSearch
                            [nzOptions]="idYCMHOptions"
                            formControlName="idYCMHs"
                            (nzOnSearch)="searchIdYCMHDelay.next($event)"
                            style="width: 100%">
                        </nz-select>
                    </div>
                </div>

                <div class="row mb-5">
                    <div class="col-12 col-md-5 ctrl_label">
                        Tờ trình nội bộ
                    </div>
                    <div class="col-12 col-md-7 select_42">
                        <nz-select formControlName="toTrinhNoiBoKey" [nzOptions]="toTrinhNoiBoOptions" nzShowSearch nzAllowClear nzPlaceHolder="Tờ trình nội bộ" class="w-100"></nz-select>
                    </div>
                </div>

                <div class="row mb-5">
                    <div class="col-12 col-md-5 ctrl_label">
                        ID đề xuất lựa chọn NCC
                    </div>
                    <div class="col-12 col-md-7 select_42">
                        <nz-select
                            nzMode="multiple"
                            nzPlaceHolder="ID đề xuất lựa chọn NCC"
                            nzAllowClear
                            nzShowSearch
                            nzServerSearch
                            [nzOptions]="nhaCungCapDeSuatOptions"
                            formControlName="idDeXuatLuaChonNCCs"
                            (nzOnSearch)="searchNhaCungCapDeSuat.next($event)"
                            style="width: 100%">
                        </nz-select>
                    </div>
                </div>

                <div class="row mb-5">
                    <div class="col-12 col-md-5 ctrl_label">
                       Bộ phận tự mua
                    </div>
                    <div class="col-12 col-md-7">
                        <label nz-checkbox formControlName="isBoPhanTuMua">Cho phép</label>
                    </div>
                </div>

                <div class="row mb-5">
                    <div class="col-12 col-md-5 ctrl_label">
                       Người cần duyệt <span class="text-danger">(*)</span>
                    </div>
                    <div class="col-12 col-md-7 select_42">
                        <nz-select formControlName="nguoiCanDuyetKeys" [nzOptions]="nguoiCanDuyetOptions" nzMode="multiple" nzShowSearch nzAllowClear nzPlaceHolder="Người cần duyệt" class="w-100"></nz-select>
                        <div class="text-form text-danger" *ngIf="f1.nguoiCanDuyetKeys.errors && f1.nguoiCanDuyetKeys.touched">
                            Người cần duyệt là bắt buộc
                        </div>
                    </div>
                </div>

                <div class="row mb-5">
                    <div class="col-12 col-md-5 ctrl_label">
                       Người nhận thông báo
                    </div>
                    <div class="col-12 col-md-7 select_42">
                        <nz-select formControlName="nguoiNhanThongBaoKeys" [nzOptions]="nguoiNhanThongBaoOptions" nzMode="multiple" nzShowSearch nzAllowClear nzPlaceHolder="Người nhận thông báo" class="w-100"></nz-select>
                    </div>
                </div>
            </form>
        </div>

        <!-- [2] -->
        <div [ngClass]="{'d-block': step == 2, 'd-none': step != 2}" class="card-body scroll-gray-8 py-0 px-10" style="max-height: calc(100vh - 275px);">
            <form [formGroup]="formGroup2">
                <div class="row mb-5">
                    <div class="col-12 col-md-5 ctrl_label">
                        Số hợp đồng <span class="text-danger">(*)</span>
                    </div>
                    <div class="col-12 col-md-7">
                        <input type="text" formControlName="soHopDong" class="form-control input_42" placeholder="Số hợp đồng">
                        <div class="text-form text-danger" *ngIf="f2.soHopDong.errors && f2.soHopDong.touched">
                            Số hợp đồng là bắt buộc
                        </div>
                    </div>
                </div>

                <div class="row mb-5">
                    <div class="col-12 col-md-5 ctrl_label">
                      Loại HĐ <span class="text-danger">(*)</span>
                    </div>
                    <div class="col-12 col-md-7 select_42">
                        <nz-select formControlName="loaiHopDongKey" [nzOptions]="loaiHopDongOptions" nzShowSearch nzAllowClear nzPlaceHolder="Loại HĐ" class="w-100"></nz-select>
                        <div class="text-form text-danger" *ngIf="f2.loaiHopDongKey.errors && f2.loaiHopDongKey.touched">
                            Loại HĐ là bắt buộc
                        </div>
                    </div>
                </div>

                <div class="row mb-5" *ngIf="f2.loaiHopDongKey.value == 'contract_principle'">
                    <div class="col-12 col-md-5 ctrl_label">
                        Giá trị hợp đồng
                    </div>
                    <div class="col-12 col-md-7 select_42">
                        <nz-select formControlName="giaTriHopDongKey" [nzOptions]="giaTriHopDongOptions" nzShowSearch nzAllowClear nzPlaceHolder="Giá trị hợp đồng" class="w-100"></nz-select>
                    </div>
                </div>

                <div class="row mb-5">
                    <div class="col-12 col-md-5 ctrl_label">
                        Điều kiện thanh toán <span class="text-danger">(*)</span>
                    </div>
                    <div class="col-12 col-md-7">
                        <input type="text" formControlName="dieuKienThanhToan" placeholder="Điều kiện thanh toán" class="form-control input_42">
                        <div class="text-form text-danger" *ngIf="f2.dieuKienThanhToan.errors && f2.dieuKienThanhToan.touched">
                            Điều kiện thanh toán là bắt buộc
                        </div>
                    </div>
                </div>

                <div class="row mb-5">
                    <div class="col-12 col-md-5 ctrl_label">
                        Bảo hành
                    </div>
                    <div class="col-12 col-md-7">
                        <input type="text" formControlName="baoHanh" placeholder="Bảo hành" class="form-control input_42">
                        <div class="text-form text-danger" *ngIf="f2.baoHanh.errors && f2.baoHanh.touched">
                            Bảo hành là bắt buộc
                        </div>
                    </div>
                </div>

                <div class="row mb-5">
                    <div class="col-12 col-md-5 ctrl_label">
                        Bảo lãnh
                    </div>
                    <div class="col-12 col-md-7">
                        <input type="text" formControlName="baoLanh" placeholder="Bảo lãnh" class="form-control input_42">
                        <div class="text-form text-danger" *ngIf="f2.baoLanh.errors && f2.baoLanh.touched">
                            Bảo lãnh là bắt buộc
                        </div>
                    </div>
                </div>

                <div class="row mb-5">
                    <div class="col-12 col-md-5 ctrl_label">
                       Đối tác ký hợp đồng <span class="text-danger">(*)</span>
                    </div>
                    <div class="col-12 col-md-7 select_42">
                        <nz-select formControlName="doiTacKyHopDongKey" [nzOptions]="doiTacKyHopDongOptions" nzShowSearch nzAllowClear nzPlaceHolder="Đối tác ký hợp đồng" class="w-100"></nz-select>
                        <div class="text-form text-danger" *ngIf="f2.doiTacKyHopDongKey.errors && f2.doiTacKyHopDongKey.touched">
                            Đối tác ký hợp đồng là bắt buộc
                        </div>
                    </div>
                </div>

                <div class="row mb-5">
                    <div class="col-12 col-md-5 ctrl_label">
                       Nội dung
                    </div>
                    <div class="col-12 col-md-7">
                        <input type="text" formControlName="noiDung" placeholder="Nội dung" class="form-control input_42">
                    </div>
                </div>

                <div class="row mb-5">
                    <div class="col-12 col-md-5 ctrl_label">
                       Ghi chú
                    </div>
                    <div class="col-12 col-md-7">
                        <textarea rows="3" formControlName="ghiChu" placeholder="Ghi chú" class="form-control input_42"></textarea>
                    </div>
                </div>
            </form>
        </div>

        <!-- [3] -->
        <div [ngClass]="{'d-block': step == 3, 'd-none': step != 3}" class="card-body scroll-gray-8 py-0 px-10" style="max-height: calc(100vh - 275px);">
            <!-- Thông tin hàng hoá -->
            <ng-container>
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <div class="font_size_17 text-blue-01">{{ 'Thông tin hàng hoá' | translate }}<span class="text-danger">(*)</span></div>
                    <div>
                        <button *ngIf="showFormNo != 1" type="button" (click)="showFormNo = 1" class="btn btn-primary h_42">
                            <i class="flaticon2-plus icon-1x"></i>{{ 'COMMON.btn.add_new_info' | translate }}
                        </button>
                    </div>
                </div>
                
                <!-- form -->
                <form [formGroup]="formGroup3" class="form_border d-none" (submit)="onThemThongTin(tableTTHangHoa)" [class.d-block]="showFormNo == 1">
                    <div #formTTHangHoa class="row mb-5">
                        <div class="col-12 col-md-6 ctrl_label">
                            Hàng hoá, dịch vụ <span class="text-danger">(*)</span>
                        </div>
                        <div class="col-12 col-md-6 select_42">
                            <nz-select formControlName="hangHoaKey" [nzOptions]="hangHoaOptions" nzShowSearch nzAllowClear nzPlaceHolder="Hàng hoá, dịch vụ" class="w-100"></nz-select>
                            <div class="text-form text-danger" *ngIf="f3.hangHoaKey.errors && f3.hangHoaKey.touched">
                                Hàng hoá, dịch vụ là bắt buộc
                            </div>
                        </div>
                    </div>
                    <div class="row mb-5">
                        <div class="col-12 col-md-6 ctrl_label">
                            Quy cách <span class="text-danger">(*)</span>
                        </div>
                        <div class="col-12 col-md-6">
                            <input type="text" formControlName="quyCach" placeholder="Quy cách" class="form-control input_42">
                            <div class="text-form text-danger" *ngIf="f3.quyCach.errors && f3.quyCach.touched">
                                Quy cách là bắt buộc
                            </div>
                        </div>
                    </div>
                    <div class="row mb-5">
                        <div class="col-12 col-md-6 ctrl_label">
                            ĐVT
                        </div>
                        <div class="col-12 col-md-6">
                            <input type="text" formControlName="dvt" placeholder="Đơn vị tính" class="form-control input_42" readonly>
                        </div>
                    </div>
                    <div class="row mb-5">
                        <div class="col-12 col-md-6 ctrl_label">
                            Số lượng <span class="text-danger">(*)</span>
                        </div>
                        <div class="col-12 col-md-6">
                            <nz-input-number
                                [nzMin]="0"
                                [nzStep]="1"
                                [nzParser]="parser"
                                [nzFormatter]="formatter"
                                formControlName="soLuong"
                                nzPlaceHolder="Số lượng" class="form-control input_42">
                            </nz-input-number>
                            <div class="text-form text-danger" *ngIf="f3.soLuong.errors && f3.soLuong.touched">
                                Số lượng là bắt buộc
                            </div>
                        </div>
                    </div>
                    <div class="row mb-5">
                        <div class="col-12 col-md-6 ctrl_label">
                            Đơn giá (Chưa VAT) <span class="text-danger">(*)</span>
                        </div>
                        <div class="col-12 col-md-6">
                            <nz-input-number
                                [nzMin]="0"
                                [nzStep]="1"
                                [nzParser]="parser"
                                [nzFormatter]="formatter"
                                formControlName="donGiaChuaVAT"
                                nzPlaceHolder="Đơn giá (Chưa VAT)" class="form-control input_42">
                            </nz-input-number>
                            <div class="text-form text-danger" *ngIf="f3.donGiaChuaVAT.errors && f3.donGiaChuaVAT.touched">
                                Đơn giá (Chưa VAT) là bắt buộc
                            </div>
                        </div>
                    </div>
                    <div class="row mb-5">
                        <div class="col-12 col-md-6 ctrl_label">
                            Thành tiền (Chưa VAT)
                        </div>
                        <div class="col-12 col-md-6">
                            <nz-input-number
                                [nzMin]="0"
                                [nzStep]="1"
                                [nzParser]="parser"
                                [nzDisabled]="true"
                                [nzFormatter]="formatter"
                                formControlName="thanhTienChuaVAT"
                                nzPlaceHolder="Chưa VAT" class="form-control input_42">
                            </nz-input-number>
                        </div>
                    </div>
                    <div class="row mb-5">
                        <div class="col-12 col-md-6 ctrl_label">
                            Ghi chú
                        </div>
                        <div class="col-12 col-md-6">
                            <textarea formControlName="ghiChu" rows="3" class="form-control input_42" maxlength="500"></textarea>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 d-flex justify-content-center">
                            <button *ngIf="showFormNo == 1" type="button" (click)="showFormNo = 0" class="btn btn-light btn-14 w_130 mx-1" [translate]="'COMMON.btn.cancel'"></button>
                            <button *ngIf="showFormNo == 1" class="btn btn-primary btn-14 w_130 mx-1" [translate]="'COMMON.btn.record'"></button>
                        </div>
                    </div>
                </form>
    
                <!-- All data -->
                <form [formGroup]="formGroup6" #tableTTHangHoa>
                    <app-table [data]="dataTableHangHoas" [maxHeight]="'300'" [radius]="true" [classNameContainer]="'mb-5'">
                        <thead>
                            <tr class="text-center">
                                <th [translate]="'STT'" [class.stick]="'true'" [style.left.px]="0"></th>
                                <th class="min_w_150" [translate]="'Hàng hoá, dịch vụ'"></th>
                                <th class="min_w_100" [translate]="'Quy cách'"></th>
                                <th class="min_w_100" [translate]="'ĐVT'"></th>
                                <th class="min_w_100" [translate]="'Số lượng'"></th>
                                <th class="min_w_150" [translate]="'Đơn giá (Chưa VAT)'"></th>
                                <th class="min_w_150" [translate]="'Thành tiền (Chưa VAT)'"></th>
                                <th class="min_w_150" [translate]="'Ghi chú'"></th>
                                <th [class.stick]="'true'" [style.right.px]="0"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let item of dataTableHangHoas; let i = index">
                                <td class="text-center" [class.stick]="'true'" [style.left.px]="0">{{i + 1}}</td>
                                <td>
                                    <span class="truncate-2" [title]="getObjOptions('hangHoaOptions', item?.hangHoaKey)?.label">{{getObjOptions('hangHoaOptions', item?.hangHoaKey)?.label || '-'}}</span>
                                </td>
                                <td>
                                    <span class="truncate-2" [title]="item?.quyCach">{{item?.quyCach || '-'}}</span>
                                </td>
                                <td>
                                    <span class="truncate-2" [title]="item?.dvt">{{item?.dvt || '-'}}</span>
                                </td>
                                <td class="text-center">{{item?.soLuong || 0 | number}}</td>
                                <td class="text-right">{{item?.donGiaChuaVAT || 0 | number}}</td>
                                <td class="text-right">{{item?.thanhTienChuaVAT || 0 | number}}</td>
                                <td>
                                    <span class="truncate-2" [title]="item?.ghiChu">{{item?.ghiChu || '-'}}</span>
                                </td>
                                <td [class.stick]="'true'" [style.right.px]="0">
                                    <i 
                                        nz-popconfirm 
                                        nzPopconfirmTitle="{{ 'COMMON.btn.are_you_sure' | translate }}" 
                                        [nzIcon]="iconTpl"
                                        [nzOkText]="'COMMON.btn.yes' | translate"
                                        [nzCancelText]="'COMMON.btn.no' | translate"
                                        class="btn btn-icon btn-hover" 
                                        (nzOnConfirm)="onDeleteRowTable('dataTableHangHoas', i)"
                                        class="fas fa-trash-alt icon-md text-danger cursor-pointer">
                                        <ng-template #iconTpl>
                                            <i nz-icon nzType="question-circle-o" style="color: red;"></i>
                                        </ng-template>
                                    </i>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="5" class="text-right">Tổng (Chưa VAT):</td>
                                <td colspan="2" class="text-right text-blue-01 font-weight-bolder">{{tongChuaVAT || 0 | number}} VNĐ</td>
                                <td></td>
                                <td [class.stick]="'true'" [style.right.px]="0"></td>
                            </tr>
                            <tr>
                                <td colspan="5" class="text-right" [style.verticalAlign]="'inherit'">Giảm giá:</td>
                                <td colspan="2" class="text-right">
                                    <div class="row align-items-center">
                                        <div class="col-10">
                                            <nz-input-number
                                                [nzMin]="0"
                                                [nzStep]="1"
                                                [nzParser]="parser"
                                                [nzFormatter]="formatter"
                                                formControlName="giamGia"
                                                [class.is-invalid]="f6?.giamGia?.errors && f6?.giamGia?.touched"
                                                nzPlaceHolder="Giảm giá" class="form-control input_42">
                                            </nz-input-number>
                                        </div>
                                        <div class="col-2 text-blue-01 font-weight-bolder pl-0">VNĐ</div>
                                    </div>  
                                </td>
                                <td></td>
                                <td [class.stick]="'true'" [style.right.px]="0"></td>
                            </tr>
                            <tr>
                                <td colspan="5" class="text-right" [style.verticalAlign]="'inherit'">VAT:</td>
                                <td colspan="2" class="text-right">
                                    <div class="row align-items-center">
                                        <div class="col-10">
                                            <nz-input-number
                                                [nzMin]="0"
                                                [nzStep]="1"
                                                [nzParser]="parser"
                                                [nzFormatter]="formatter"
                                                formControlName="vat"
                                                [class.is-invalid]="f6?.vat?.errors && f6?.vat?.touched"
                                                nzPlaceHolder="VAT" class="form-control input_42">
                                            </nz-input-number>  
                                        </div>
                                        <div class="col-2 text-blue-01 font-weight-bolder pl-0">VNĐ</div>
                                    </div>  
                                </td>
                                <td></td>
                                <td [class.stick]="'true'" [style.right.px]="0"></td>
                            </tr>
                            <tr>
                                <td colspan="5" class="text-right">Tổng tiền (Đã VAT):</td>
                                <td colspan="2" class="text-right text-blue-01 font-weight-bolder">{{tongDaCoVAT || 0 | number}} VNĐ</td>
                                <td></td>
                                <td [class.stick]="'true'" [style.right.px]="0"></td>
                            </tr>
                        </tbody>
                    </app-table>
                </form>
            </ng-container>
            <!-- Dự thảo hợp đồng -->
            <ng-container>
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <div class="font_size_17 text-blue-01">{{ 'Dự thảo hợp đồng' | translate }}<span class="text-danger">(*)</span></div>
                    <div>
                        <button *ngIf="showFormNo != 2" type="button" (click)="showFormNo = 2" class="btn btn-primary h_42">
                            <i class="flaticon2-plus icon-1x"></i>{{ 'Thêm hợp đồng' | translate }}
                        </button>
                    </div>
                </div>
                
                <!-- form -->
                <form [formGroup]="formGroup4" class="form_border d-none" (submit)="onThemDTHopDong(tableDTHopDong)" [class.d-block]="showFormNo == 2">
                    <div #formDTHopDong class="row mb-5">
                        <div class="col-12 col-md-5 ctrl_label">
                            Ghi chú 
                        </div>
                        <div class="col-12 col-md-7">
                            <textarea rows="3" formControlName="ghiChu" placeholder="Ghi chú" class="form-control input_42"></textarea>
                        </div>
                    </div>
                    
                    <div class="row mb-5">
                        <div class="col-12 col-md-5 ctrl_label">
                            {{ 'Tài liệu đính kèm' | translate }} <span class="text-danger">(*)</span>
                        </div>
                        <div class="col-12 col-md-7">
                            <!-- New data -->
                            <div class="row">
                                <div class="col-12 col-md-6 mb-5 mb-md-0 select_42">
                                    <div
                                        *ngFor="let item of selectedFiles; trackBy:trackByFn"
                                        class="col-12 d-flex align-items-center mb-1 px-0"
                                        [style.height.px]="30.65"
                                        [title]="getObjOptions('loaiTaiLieuOptions',item?.attachKey)?.label || item?.taiLieuDinhKemDisplay">
                                        <div class="truncate">
                                            {{ getObjOptions('loaiTaiLieuOptions',item?.attachKey)?.label || item?.taiLieuDinhKemDisplay }}
                                        </div>
                                    </div>
                                    <nz-select nzShowSearch nzAllowClear nzPlaceHolder="{{ 'PURCHASE.CREATE.step_1.form.attachments.placeholder' | translate }}"
                                        formControlName="taiLieuDinhKemKey"
                                        [nzOptions]="loaiTaiLieuOptions" class="w-100 mt-1">
                                    </nz-select>
                                </div>
                                <div class="col-12 col-md-6">
                                    <app-select-file 
                                        [reset]="false" 
                                        [multiple]="true" 
                                        [base64Content]="true" 
                                        [attachKey]="f4.taiLieuDinhKemKey.value" 
                                        [acceptKey]="'excel_word_pdf_rar_zip'" 
                                        [text]="'Tải lên văn bản'" 
                                        [unChoose]="!f4.taiLieuDinhKemKey.value"
                                        (unChooseChange)="loaiTaiLieuRequired()"
                                        [(selectedFiles)]="selectedFiles">
                                    </app-select-file>
                                </div>
                            </div>
                            <div class="text-form text-danger" *ngIf="formGroup4.touched && selectedFiles?.length == 0">
                                {{ 'Tài liệu đính kèm là bắt buộc' | translate }}
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12 d-flex justify-content-center">
                            <button *ngIf="showFormNo == 2" type="button" (click)="showFormNo = 0" class="btn btn-light btn-14 w_130 mx-1" [translate]="'COMMON.btn.cancel'"></button>
                            <button *ngIf="showFormNo == 2" class="btn btn-primary btn-14 w_130 mx-1" [translate]="'COMMON.btn.record'"></button>
                        </div>
                    </div>
                </form>
    
                <!-- All data -->
                <div #tableDTHopDong></div>
                <app-table [data]="dataTableDuThaoHopDongs" [maxHeight]="'300'" [radius]="true" [classNameContainer]="'mb-5'">
                    <thead>
                        <tr class="text-center">
                            <th class="w_50" [translate]="'STT'"></th>
                            <th [style.maxWidth.px]="366" [translate]="'File'"></th>
                            <th [style.maxWidth.px]="366" [translate]="'Ghi chú'"></th>
                            <th class="w_40"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let item of dataTableDuThaoHopDongs; let i = index">
                            <td class="w_50 text-center">{{i + 1}}</td>
                            <td>
                                <div class="truncate-2" [title]="f?.fileName" *ngFor="let f of item?.files">
                                    <i class="flaticon2-file-1 icon-md text-warning mr-3"></i>
                                    <a href="javascript:void()" (click)="api.downloadURI(f?.base64, f?.fileName)">{{f?.fileName || '-'}}</a>
                                </div>
                            </td>
                            <td>
                                <span class="truncate-2" [title]="item?.ghiChu">{{item?.ghiChu || '-'}}</span>
                            </td>
                            <td class="w_40 text-center">
                                <i 
                                    nz-popconfirm 
                                    nzPopconfirmTitle="{{ 'COMMON.btn.are_you_sure' | translate }}" 
                                    [nzIcon]="iconTpl"
                                    [nzOkText]="'COMMON.btn.yes' | translate"
                                    [nzCancelText]="'COMMON.btn.no' | translate"
                                    class="btn btn-icon btn-hover" 
                                    (nzOnConfirm)="onDeleteRowTable('dataTableDuThaoHopDongs', i)"
                                    class="fas fa-trash-alt icon-md text-danger cursor-pointer">
                                    <ng-template #iconTpl>
                                        <i nz-icon nzType="question-circle-o" style="color: red;"></i>
                                    </ng-template>
                                </i>
                            </td>
                        </tr>
                    </tbody>
                </app-table>
            </ng-container>
            <!-- Tài liệu đính kèm -->
            <ng-container>
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <div class="font_size_17 text-blue-01" [translate]="'Tài liệu đính kèm'"></div>
                    <div>
                        <button *ngIf="showFormNo != 3" type="button" (click)="showFormNo = 3" class="btn btn-primary h_42">
                            <i class="flaticon2-plus icon-1x"></i>{{ 'Thêm tài liệu' | translate }}
                        </button>
                    </div>
                </div>
                
                <!-- form -->
                <form [formGroup]="formGroup5" class="form_border d-none" (submit)="onThemTLDinhKem(tableTLDinhKem)" [class.d-block]="showFormNo == 3">
                    <div #formTLDinhKem class="row mb-5">
                        <div class="col-12 col-md-5 ctrl_label">
                            Ghi chú
                        </div>
                        <div class="col-12 col-md-7">
                            <textarea rows="3" formControlName="ghiChu" placeholder="Ghi chú" class="form-control input_42"></textarea>
                        </div>
                    </div>
                    
                    <div class="row mb-5">
                        <div class="col-12 col-md-5 ctrl_label">
                            {{ 'Tài liệu đính kèm' | translate }} <span class="text-danger">(*)</span>
                        </div>
                        <div class="col-12 col-md-7">
                            <!-- New data -->
                            <div class="row">
                                <div class="col-12 col-md-6 mb-5 mb-md-0 select_42">
                                    <div
                                        *ngFor="let item of selectedFiles; trackBy:trackByFn"
                                        class="col-12 d-flex align-items-center mb-1 px-0"
                                        [style.height.px]="30.65"
                                        [title]="getObjOptions('loaiTaiLieuOptions',item?.attachKey)?.label || item?.taiLieuDinhKemDisplay">
                                        <div class="truncate">
                                            {{ getObjOptions('loaiTaiLieuOptions',item?.attachKey)?.label || item?.taiLieuDinhKemDisplay }}
                                        </div>
                                    </div>
                                    <nz-select nzShowSearch nzAllowClear nzPlaceHolder="{{ 'PURCHASE.CREATE.step_1.form.attachments.placeholder' | translate }}"
                                        formControlName="taiLieuDinhKemKey"
                                        [nzOptions]="loaiTaiLieuOptions" class="w-100 mt-1">
                                    </nz-select>
                                </div>
                                <div class="col-12 col-md-6">
                                    <app-select-file 
                                        [reset]="false" 
                                        [multiple]="true" 
                                        [base64Content]="true" 
                                        [attachKey]="f5.taiLieuDinhKemKey.value" 
                                        [acceptKey]="'excel_word_pdf_rar_zip'" 
                                        [text]="'Tải lên văn bản'" 
                                        [unChoose]="!f5.taiLieuDinhKemKey.value"
                                        (unChooseChange)="loaiTaiLieuRequired()"
                                        [(selectedFiles)]="selectedFiles">
                                    </app-select-file>
                                </div>
                            </div>
                            <div class="text-form text-danger" *ngIf="formGroup5.touched && selectedFiles?.length == 0">
                                {{ 'Tài liệu đính kèm là bắt buộc' | translate }}
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12 d-flex justify-content-center">
                            <button *ngIf="showFormNo == 3" type="button" (click)="showFormNo = 0" class="btn btn-light btn-14 w_130 mx-1" [translate]="'COMMON.btn.cancel'"></button>
                            <button *ngIf="showFormNo == 3" class="btn btn-primary btn-14 w_130 mx-1" [translate]="'COMMON.btn.record'"></button>
                        </div>
                    </div>
                </form>
    
                <!-- All data -->
                <div #tableTLDinhKem></div>
                <app-table [data]="dataTableDinhKems" [maxHeight]="'300'" [radius]="true" [classNameContainer]="'mb-5'">
                    <thead>
                        <tr class="text-center">
                            <th class="w_50" [translate]="'STT'"></th>
                            <th [style.maxWidth.px]="366" [translate]="'File'"></th>
                            <th [style.maxWidth.px]="366" [translate]="'Ghi chú'"></th>
                            <th class="w_40"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let item of dataTableDinhKems; let i = index">
                            <td class="w_50 text-center">{{i + 1}}</td>
                            <td>
                                <div class="truncate-2" [title]="f?.fileName" *ngFor="let f of item?.files">
                                    <i class="flaticon2-file-1 icon-md text-warning mr-3"></i>
                                    <a href="javascript:void()" (click)="api.downloadURI(f?.base64, f?.fileName)">{{f?.fileName}}</a>
                                </div>
                            </td>
                            <td>
                                <span class="truncate-2" [title]="item?.ghiChu">{{item?.ghiChu || '-'}}</span>
                            </td>
                            <td class="w_40 text-center">
                                <i 
                                    nz-popconfirm 
                                    nzPopconfirmTitle="{{ 'COMMON.btn.are_you_sure' | translate }}" 
                                    [nzIcon]="iconTpl"
                                    [nzOkText]="'COMMON.btn.yes' | translate"
                                    [nzCancelText]="'COMMON.btn.no' | translate"
                                    class="btn btn-icon btn-hover" 
                                    (nzOnConfirm)="onDeleteRowTable('dataTableDinhKems', i)"
                                    class="fas fa-trash-alt icon-md text-danger cursor-pointer">
                                    <ng-template #iconTpl>
                                        <i nz-icon nzType="question-circle-o" style="color: red;"></i>
                                    </ng-template>
                                </i>
                            </td>
                        </tr>
                    </tbody>
                </app-table>
            </ng-container>
        </div>

        <!-- [4] -->
        <div [ngClass]="{'d-block': step == 4, 'd-none': step != 4}" class="card-body scroll-gray-8 py-0 px-10" style="max-height: calc(100vh - 275px);">
            <div class="pb-5">
                <div class="detail_header">
                    <div class="text-left">
                        <div class="company"> CÔNG TY CỔ PHẦN LIÊN DOANH Ô TÔ HYUNDAI THÀNH CÔNG VIỆT NAM (HTV)</div>
                        <!-- <div class="no">Số DNKHD: <b></b></div> -->
                    </div>
                    <div class="text-right">
                        <div><img src="assets/media/logos/ycmh_logo_paper.png" alt="logo" height="16" width="240"></div>
                        <div class="today">Hà Nội, Ngày {{today | date: 'dd'}} tháng {{today | date: 'MM'}} năm {{today | date: 'yyyy'}}</div>
                    </div>
                </div>
                <div class="detail_name">
                    <p>ĐỀ NGHỊ KÝ HỢP ĐỒNG</p>
                    <p><i>QUYẾT ĐỊNH VỀ VIỆC BAN HÀNH TỔ CHỨC, QUẢN LÝ</i></p>
                </div>
                <!-- Thông tin yêu cầu -->
                <div class="my-5 text-blue-01 font_size_16 font-weight-bolder">Thông tin yêu cầu</div>
                <app-table [data]="[1]" [maxHeight]="'300'" [radius]="true" [classNameContainer]="'mb-5'">
                    <tbody>
                        <tr>
                            <td class="min_w_180">ID yêu cầu mua hàng</td>
                            <td class="max_w_250 text-blue-01 font_size_14 font-weight-bolder">
                                <ul class="pl-6 mb-0 text-left">
                                    <li *ngFor="let n of f1.idYCMHs.value">
                                        <span class="truncate-2" [title]="n">{{n}}</span>
                                    </li>
                                </ul>
                            </td>
                            <td class="min_w_180">Số đề xuất lựa chọn NCC</td>
                            <td class="max_w_250 text-blue-01 font_size_14 font-weight-bolder">
                                <ul class="pl-6 mb-0 text-left">
                                    <li *ngFor="let n of getObjOptions('nhaCungCapDeSuatOptions', f1.idDeXuatLuaChonNCCs.value)">
                                        <span class="truncate-2" [title]="n">{{n}}</span>
                                    </li>
                                </ul>
                            </td>
                        </tr>
                        <tr>
                            <td>Bộ phận tự mua</td>
                            <td class="text-blue-01 font_size_14 font-weight-bolder">
                                <span class="truncate-2" [title]="f1.isBoPhanTuMua.value ? 'Cho phép' : 'Không cho phép'">{{f1.isBoPhanTuMua.value ? 'Cho phép' : 'Không cho phép'}}</span>
                            </td>
                            <td>Người cần duyệt</td>
                            <td class="text-blue-01 font_size_14 font-weight-bolder">
                                <ul class="pl-6 mb-0 text-left">
                                    <li *ngFor="let n of getObjOptions('nguoiCanDuyetOptions', f1.nguoiCanDuyetKeys.value)">
                                        <span class="truncate-2" [title]="n">{{n}}</span>
                                    </li>
                                </ul>
                            </td>
                        </tr>
                        <tr>
                            <td>Người nhận thông báo</td>
                            <td class="text-blue-01 font_size_14 font-weight-bolder">
                                <ul class="pl-6 mb-0 text-left">
                                    <li *ngFor="let n of getObjOptions('nguoiNhanThongBaoOptions', f1.nguoiNhanThongBaoKeys.value)">
                                        <span class="truncate-2" [title]="n">{{n}}</span>
                                    </li>
                                </ul>
                            </td>
                            <td>Số hợp đồng</td>
                            <td class="text-blue-01 font_size_14 font-weight-bolder">
                                <span class="truncate-2" [title]="f2.soHopDong.value">{{f2.soHopDong.value || '-'}}</span>
                            </td>
                        </tr>
                        <tr>
                            <td>Loại hợp đồng</td>
                            <td class="text-blue-01 font_size_14 font-weight-bolder">
                                <span class="truncate-2" [title]="getObjOptions('loaiHopDongOptions', f2.loaiHopDongKey.value)?.label">{{getObjOptions('loaiHopDongOptions', f2.loaiHopDongKey.value)?.label || '-'}}</span>
                            </td>
                            <td>Điều kiện thanh toán</td>
                            <td class="text-blue-01 font_size_14 font-weight-bolder">
                                <span class="truncate-2" [title]="f2.dieuKienThanhToan.value">{{f2.dieuKienThanhToan.value || '-'}}</span>
                            </td>
                        </tr>
                        <tr>
                            <td>Bảo hành</td>
                            <td class="text-blue-01 font_size_14 font-weight-bolder">
                                <span class="truncate-2" [title]="f2.baoHanh.value">{{f2.baoHanh.value || '-'}}</span>
                            </td>
                            <td>Bảo lãnh</td>
                            <td class="text-blue-01 font_size_14 font-weight-bolder">
                                <span class="truncate-2" [title]="f2.baoLanh.value">{{f2.baoLanh.value || '-'}}</span>
                            </td>
                        </tr>
                        <tr>
                            <td>Nội dung</td>
                            <td colspan="3" class="text-blue-01 font_size_14 font-weight-bolder">
                                <span class="truncate-2" [title]="f2.noiDung.value">{{f2.noiDung.value || '-'}}</span>
                            </td>
                        </tr>
                        <tr>
                            <td>Ghi chú</td>
                            <td colspan="3" class="text-blue-01 font_size_14 font-weight-bolder">
                                <span class="truncate-2" [title]="f2.ghiChu.value">{{f2.ghiChu.value || '-'}}</span>
                            </td>
                        </tr>
                    </tbody>
                </app-table>
                <!-- Kết quả lựa chọn nhà cung cấp -->
                <div class="mb-5 text-blue-01 font_size_16 font-weight-bolder">Với danh mục hàng hoá và chi phí dự kiến như sau:</div>
                <app-table [data]="dataTableHangHoas" [maxHeight]="'300'" [radius]="true" [classNameContainer]="'mb-5'" [className]="'table_blue'">
                    <thead>
                        <tr class="text-center">
                            <th [translate]="'STT'"></th>
                            <th class="min_w_150" [translate]="'Hàng hoá, dịch vụ'"></th>
                            <th class="min_w_100" [translate]="'Quy cách'"></th>
                            <th class="min_w_100" [translate]="'ĐVT'"></th>
                            <th class="min_w_100" [translate]="'Số lượng'"></th>
                            <th class="min_w_150" [translate]="'Đơn giá (Chưa VAT)'"></th>
                            <th class="min_w_150" [translate]="'Thành tiền (Chưa VAT)'"></th>
                            <th class="min_w_150" [translate]="'Ghi chú'"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let item of dataTableHangHoas; let i = index">
                            <td class="text-center">{{i + 1}}</td>
                            <td>
                                <span class="truncate-2" [title]="getObjOptions('hangHoaOptions', item?.hangHoaKey)?.label">{{getObjOptions('hangHoaOptions', item?.hangHoaKey)?.label || '-'}}</span>
                            </td>
                            <td>
                                <span class="truncate-2" [title]="item?.quyCach">{{item?.quyCach || '-'}}</span>
                            </td>
                            <td>
                                <span class="truncate-2" [title]="item?.dvt">{{item?.dvt || '-'}}</span>
                            </td>
                            <td class="text-center">{{item?.soLuong || 0 | number}}</td>
                            <td class="text-right">{{item?.donGiaChuaVAT || 0 | number}}</td>
                            <td class="text-right">{{item?.thanhTienChuaVAT || 0 | number}}</td>
                            <td>
                                <span class="truncate-2" [title]="item?.ghiChu">{{item?.ghiChu || '-'}}</span>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="4" class="text-right">Tổng (Chưa VAT):</td>
                            <td colspan="2" class="text-right text-blue-01 font-weight-bolder">{{tongChuaVAT || 0 | number}} VNĐ</td>
                            <td></td>
                        </tr>
                        <tr>
                            <td colspan="4" class="text-right" [style.verticalAlign]="'inherit'">Giảm giá:</td>
                            <td colspan="2" class="text-right text-blue-01 font-weight-bolder">{{f6?.giamGia.value || 0 | number}} VNĐ</td>
                            <td></td>
                        </tr>
                        <tr>
                            <td colspan="4" class="text-right" [style.verticalAlign]="'inherit'">VAT:</td>
                            <td colspan="2" class="text-right text-blue-01 font-weight-bolder">{{f6?.vat.value || 0 | number}} VNĐ</td>
                            <td></td>
                        </tr>
                        <tr>
                            <td colspan="4" class="text-right">Tổng tiền (Đã VAT):</td>
                            <td colspan="2" class="text-right text-blue-01 font-weight-bolder">{{tongDaCoVAT || 0 | number}} VNĐ</td>
                            <td></td>
                        </tr>
                    </tbody>
                </app-table>
                <!-- Dự thảo hợp đồng -->
                <div class="mb-5 text-blue-01 font_size_16 font-weight-bolder">Dự thảo hợp đồng</div>
                <app-table [data]="dataTableDuThaoHopDongs" [maxHeight]="'300'" [radius]="true" [classNameContainer]="'mb-5'" [className]="'table_blue'">
                    <thead>
                        <tr class="text-center">
                            <th class="w_50" [translate]="'STT'"></th>
                            <th [style.maxWidth.px]="386" [translate]="'File'"></th>
                            <th [style.maxWidth.px]="386" [translate]="'Ghi chú'"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let item of dataTableDuThaoHopDongs; let i = index">
                            <td class="w_50 text-center">{{i + 1}}</td>
                            <td>
                                <div class="truncate-2" [title]="f?.fileName" *ngFor="let f of item?.files">
                                    <i class="flaticon2-file-1 icon-md text-warning mr-3"></i>
                                    <a href="javascript:void()" (click)="api.downloadURI(f?.base64, f?.fileName)">{{f?.fileName || '-'}}</a>
                                </div>
                            </td>
                            <td>
                                <span class="truncate-2" [title]="item?.ghiChu">{{item?.ghiChu || '-'}}</span>
                            </td>
                        </tr>
                    </tbody>
                </app-table>
                <!-- Tài liệu đính kèm -->
                <div class="mb-5 text-blue-01 font_size_16 font-weight-bolder">Tài liệu đính kèm</div>
                <app-table [data]="dataTableDinhKems" [maxHeight]="'300'" [radius]="true" [classNameContainer]="'mb-5'" [className]="'table_blue'">
                    <thead>
                        <tr class="text-center">
                            <th class="w_50" [translate]="'STT'"></th>
                            <th [style.maxWidth.px]="386" [translate]="'File'"></th>
                            <th [style.maxWidth.px]="386" [translate]="'Ghi chú'"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let item of dataTableDinhKems; let i = index">
                            <td class="w_50 text-center">{{i + 1}}</td>
                            <td>
                                <div class="truncate-2" [title]="f?.fileName" *ngFor="let f of item?.files">
                                    <i class="flaticon2-file-1 icon-md text-warning mr-3"></i>
                                    <a href="javascript:void()" (click)="api.downloadURI(f?.base64, f?.fileName)">{{f?.fileName || '-'}}</a>
                                </div>
                            </td>
                            <td>
                                <span class="truncate-2" [title]="item?.ghiChu">{{item?.ghiChu || '-'}}</span>
                            </td>
                        </tr>
                    </tbody>
                </app-table>
            </div>
        </div>

        <!-- [Action] -->
        <div class="footer">
            <div class="d-flex justify-content-between">
                <div class="mr-2">
                    <button *ngIf="step > 1" class="btn btn-light btn-14 py-3 w_130" (click)="prevStep()"
                        [translate]="'COMMON.btn.before'">Trước</button>
                </div>
                <div>
                    <div [ngSwitch]="step" class="d-flex">
                        <div>
                            <button 
                                nz-popconfirm 
                                nzPopconfirmTitle="{{ 'COMMON.btn.are_you_sure' | translate }}"
                                [nzIcon]="iconTpl" 
                                [nzOkText]="'COMMON.btn.yes' | translate"
                                [nzCancelText]="'COMMON.btn.no' | translate"
                                class="btn btn-light btn-14 py-3 w_130 mr-2" 
                                (nzOnCancel)="isVisible = true" 
                                (nzOnConfirm)="isVisible = false"
                                [translate]="'COMMON.btn.cancel'">
                            </button>
                            <ng-template #iconTpl>
                                <i nz-icon nzType="question-circle-o" style="color: red;"></i>
                            </ng-template>
                        </div>
                        <div *ngSwitchCase="'1'">
                            <button class="btn btn-primary btn-14 py-3 w_130" (click)="nextStep(2)"
                                [translate]="'COMMON.btn.next'"></button>
                        </div>
                        <div *ngSwitchCase="'2'">
                            <button class="btn btn-primary btn-14 py-3 w_130" (click)="nextStep(3)"
                                [translate]="'COMMON.btn.next'"></button>
                        </div>
                        <div *ngSwitchCase="'3'">
                            <button class="btn btn-primary btn-14 py-3 w_130" (click)="nextStep(4)"
                                [translate]="'COMMON.btn.next'"></button>
                        </div>
                        <div *ngSwitchCase="'4'">
                            <button class="btn btn-primary btn-14 py-3 w_130" (click)="onSubmit()" [translate]="'COMMON.btn.save'"></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</nz-modal>